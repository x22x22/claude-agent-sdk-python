# Claude Agent SDK Python æ¶ˆæ¯ç±»å‹åˆ†ææŠ¥å‘Š

## æ¦‚è¿°

æœ¬æŠ¥å‘Šåˆ†æäº† Claude Agent SDK Python é¡¹ç›®ä¸­æŠ¥æ–‡ï¼ˆæ¶ˆæ¯ï¼‰çš„ç¬¬ä¸€å±‚ `type` å­—æ®µçš„å®šä¹‰åŠå…¶åŒ…å«çš„å…·ä½“æ¶ˆæ¯å†…å®¹ã€‚è¯¥SDKä½¿ç”¨åŸºäº JSON çš„æ¶ˆæ¯åè®®ä¸ Claude Code CLI è¿›è¡Œé€šä¿¡ã€‚

## ä¸€ã€æ¶ˆæ¯ç±»å‹æ¶æ„

æ¶ˆæ¯çš„ç¬¬ä¸€å±‚åŒ…å«ä¸€ä¸ª `type` å­—æ®µï¼Œç”¨äºåŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯ã€‚ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š

### 1. `type: "user"` - ç”¨æˆ·æ¶ˆæ¯

**å®šä¹‰ä½ç½®**: `src/claude_agent_sdk/types.py` (ç¬¬561-567è¡Œ)

**æ•°æ®ç»“æ„**:
```python
@dataclass
class UserMessage:
    content: str | list[ContentBlock]
    uuid: str | None = None
    parent_tool_use_id: str | None = None
```

**å­—æ®µè¯´æ˜**:
- `content`: ç”¨æˆ·æ¶ˆæ¯çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯ç®€å•å­—ç¬¦ä¸²æˆ–å†…å®¹å—åˆ—è¡¨
- `uuid`: æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå¯é€‰ï¼‰ï¼Œç”¨äºæ–‡ä»¶æ£€æŸ¥ç‚¹åŠŸèƒ½
- `parent_tool_use_id`: çˆ¶å·¥å…·ä½¿ç”¨IDï¼ˆå¯é€‰ï¼‰ï¼Œç”¨äºå­ä»£ç†åœºæ™¯

**æ¶ˆæ¯å†…å®¹**:
ç”¨æˆ·æ¶ˆæ¯å¯ä»¥åŒ…å«ä»¥ä¸‹ç±»å‹çš„å†…å®¹å—ï¼ˆContentBlockï¼‰ï¼š
- **TextBlock**: çº¯æ–‡æœ¬å†…å®¹
  ```python
  {"type": "text", "text": "å…·ä½“çš„æ–‡æœ¬å†…å®¹"}
  ```
- **ToolUseBlock**: å·¥å…·ä½¿ç”¨è¯·æ±‚
  ```python
  {
      "type": "tool_use",
      "id": "tool_123",
      "name": "Read",
      "input": {"file_path": "/example.txt"}
  }
  ```
- **ToolResultBlock**: å·¥å…·æ‰§è¡Œç»“æœ
  ```python
  {
      "type": "tool_result",
      "tool_use_id": "tool_456",
      "content": "å·¥å…·è¿”å›çš„å†…å®¹",
      "is_error": false
  }
  ```

**ä½¿ç”¨åœºæ™¯**:
- ç”¨æˆ·å‘ Claude å‘é€çš„æç¤ºè¯æˆ–é—®é¢˜
- åœ¨å¤šè½®å¯¹è¯ä¸­ç”¨æˆ·çš„åç»­è¾“å…¥
- åŒ…å«å·¥å…·è°ƒç”¨è¯·æ±‚çš„æ¶ˆæ¯ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰
- è¿”å›å·¥å…·æ‰§è¡Œç»“æœç»™ Claudeï¼ˆå¸¸è§åœºæ™¯ï¼‰

#### ç‰¹åˆ«è¯´æ˜ï¼š`tool_use` å’Œ `tool_result` åœ¨ç”¨æˆ·æ¶ˆæ¯ä¸­çš„ä½¿ç”¨

**`tool_result` åœ¨ `user` æ¶ˆæ¯ä¸­ï¼ˆå¸¸è§ï¼‰**ï¼š

è¿™æ˜¯**æ ‡å‡†çš„å·¥å…·æ‰§è¡Œæµç¨‹**ã€‚è™½ç„¶æ¶ˆæ¯ç±»å‹æ˜¯ `user`ï¼Œä½†è¿™ä¸æ˜¯äººç±»ç”¨æˆ·å‘é€çš„ï¼Œè€Œæ˜¯ CLI ä»£è¡¨å·¥å…·æ‰§è¡Œç¯å¢ƒè¿”å›çš„ç»“æœã€‚ç¬¦åˆ Anthropic Messages API çš„è®¾è®¡ï¼Œå·¥å…·ç»“æœå¿…é¡»ä½œä¸ºç”¨æˆ·æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†å‘é€ã€‚

å®Œæ•´æµç¨‹ï¼š
1. **Claude è¯·æ±‚ä½¿ç”¨å·¥å…·** â†’ `assistant` æ¶ˆæ¯åŒ…å« `tool_use` å—
2. **CLI è‡ªåŠ¨æ‰§è¡Œå·¥å…·** â†’ CLI è°ƒç”¨å®é™…çš„å·¥å…·ï¼ˆè¯»æ–‡ä»¶ã€æ‰§è¡Œå‘½ä»¤ç­‰ï¼‰
3. **å·¥å…·ç»“æœè¿”å›ç»™ Claude** â†’ `user` æ¶ˆæ¯åŒ…å« `tool_result` å—

**äººç±»ç”¨æˆ·äº¤äº’æ–¹å¼**ï¼š
- âœ… **è‡ªç„¶è¯­è¨€æè¿°**ï¼šç”¨æˆ·åªéœ€ç”¨è‡ªç„¶è¯­è¨€è¯´"å¸®æˆ‘è¯»å– example.txt"
- âŒ **ä¸éœ€è¦ç¼–å†™ä»£ç **ï¼šæ•´ä¸ªå·¥å…·æ‰§è¡Œæµç¨‹æ˜¯è‡ªåŠ¨çš„
- ğŸ”„ **è‡ªåŠ¨åŒ–æµç¨‹**ï¼šClaude å†³å®šä½¿ç”¨å·¥å…· â†’ CLI æ‰§è¡Œ â†’ ç»“æœè¿”å› â†’ Claude ç»§ç»­å›å¤

**`tool_use` åœ¨ `user` æ¶ˆæ¯ä¸­ï¼ˆç‰¹æ®Šï¼‰**ï¼š

è¿™ç§æƒ…å†µè¾ƒå°‘è§ï¼Œä¸»è¦ç”¨äºï¼š

1. **å­ä»£ç†ï¼ˆSubagentï¼‰åœºæ™¯**
   - çˆ¶ä»£ç†è°ƒç”¨å­ä»£ç†æ—¶ï¼Œä¼šåœ¨ç”¨æˆ·æ¶ˆæ¯ä¸­åŒ…å« `tool_use`
   - é€šè¿‡ `parent_tool_use_id` å­—æ®µå…³è”

2. **ç¨‹åºåŒ–æ³¨å…¥å·¥å…·è°ƒç”¨**
   - SDK ç”¨æˆ·å¯ä»¥é€šè¿‡ä»£ç ç›´æ¥æ„é€ åŒ…å« `tool_use` çš„ç”¨æˆ·æ¶ˆæ¯
   - ç”¨äºé«˜çº§åœºæ™¯ï¼Œå¦‚é¢„å¡«å……å¯¹è¯å†å²æˆ–æµ‹è¯•
   - ç¤ºä¾‹ï¼š
     ```python
     await client.send_message({
         "type": "user",
         "message": {
             "content": [
                 {"type": "text", "text": "Let me read this file"},
                 {"type": "tool_use", "id": "tool_123", "name": "Read", 
                  "input": {"file_path": "/example.txt"}}
             ]
         }
     })
     ```

**æ€»ç»“**ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·åªéœ€è¦ç”¨è‡ªç„¶è¯­è¨€æè¿°éœ€æ±‚ï¼Œä¸éœ€è¦ç¼–å†™ä»»ä½•å·¥å…·è°ƒç”¨ä»£ç ã€‚

---

### 2. `type: "assistant"` - åŠ©æ‰‹æ¶ˆæ¯

**å®šä¹‰ä½ç½®**: `src/claude_agent_sdk/types.py` (ç¬¬570-577è¡Œ)

**æ•°æ®ç»“æ„**:
```python
@dataclass
class AssistantMessage:
    content: list[ContentBlock]
    model: str
    parent_tool_use_id: str | None = None
    error: AssistantMessageError | None = None
```

**å­—æ®µè¯´æ˜**:
- `content`: åŠ©æ‰‹å›å¤çš„å†…å®¹å—åˆ—è¡¨
- `model`: ä½¿ç”¨çš„æ¨¡å‹åç§°ï¼ˆå¦‚ "claude-opus-4-1-20250805"ï¼‰
- `parent_tool_use_id`: çˆ¶å·¥å…·ä½¿ç”¨IDï¼ˆå¯é€‰ï¼‰ï¼Œç”¨äºå­ä»£ç†åœºæ™¯
- `error`: é”™è¯¯ç±»å‹ï¼ˆå¯é€‰ï¼‰ï¼Œå¯èƒ½çš„å€¼åŒ…æ‹¬ï¼š
  - `"authentication_failed"` - è®¤è¯å¤±è´¥
  - `"billing_error"` - è®¡è´¹é”™è¯¯
  - `"rate_limit"` - é€Ÿç‡é™åˆ¶
  - `"invalid_request"` - æ— æ•ˆè¯·æ±‚
  - `"server_error"` - æœåŠ¡å™¨é”™è¯¯
  - `"unknown"` - æœªçŸ¥é”™è¯¯

**æ¶ˆæ¯å†…å®¹**:
åŠ©æ‰‹æ¶ˆæ¯å¯ä»¥åŒ…å«ä»¥ä¸‹ç±»å‹çš„å†…å®¹å—ï¼š
- **TextBlock**: Claude çš„æ–‡æœ¬å›å¤
  ```python
  {"type": "text", "text": "Claude çš„å›ç­”"}
  ```
- **ThinkingBlock**: Claude çš„æ€è€ƒè¿‡ç¨‹ï¼ˆæ‰©å±•æ€è€ƒåŠŸèƒ½ï¼‰
  ```python
  {
      "type": "thinking",
      "thinking": "æˆ‘æ­£åœ¨æ€è€ƒè¿™ä¸ªé—®é¢˜...",
      "signature": "sig-123"
  }
  ```
- **ToolUseBlock**: Claude è¯·æ±‚ä½¿ç”¨å·¥å…·
  ```python
  {
      "type": "tool_use",
      "id": "tool_789",
      "name": "Bash",
      "input": {"command": "ls -la"}
  }
  ```
- **ToolResultBlock**: å·¥å…·æ‰§è¡Œç»“æœï¼ˆåœ¨æŸäº›æƒ…å†µä¸‹ï¼‰
  ```python
  {
      "type": "tool_result",
      "tool_use_id": "tool_789",
      "content": "æ–‡ä»¶åˆ—è¡¨...",
      "is_error": false
  }
  ```

**ä½¿ç”¨åœºæ™¯**:
- Claude å¯¹ç”¨æˆ·é—®é¢˜çš„æ–‡æœ¬å›å¤
- Claude è¯·æ±‚ä½¿ç”¨å·¥å…·ï¼ˆå¦‚è¯»å–æ–‡ä»¶ã€æ‰§è¡Œå‘½ä»¤ç­‰ï¼‰
- Claude çš„æ‰©å±•æ€è€ƒå†…å®¹
- API é”™è¯¯å“åº”

---

### 3. `type: "system"` - ç³»ç»Ÿæ¶ˆæ¯

**å®šä¹‰ä½ç½®**: `src/claude_agent_sdk/types.py` (ç¬¬580-584è¡Œ)

**æ•°æ®ç»“æ„**:
```python
@dataclass
class SystemMessage:
    subtype: str
    data: dict[str, Any]
```

**å­—æ®µè¯´æ˜**:
- `subtype`: ç³»ç»Ÿæ¶ˆæ¯çš„å­ç±»å‹ï¼Œæ ‡è¯†å…·ä½“çš„ç³»ç»Ÿäº‹ä»¶
- `data`: åŒ…å«å®Œæ•´æ¶ˆæ¯æ•°æ®çš„å­—å…¸

**æ¶ˆæ¯å­ç±»å‹** (`subtype` å­—æ®µçš„å¯èƒ½å€¼):
- `"init"` - åˆå§‹åŒ–æ¶ˆæ¯
  - åŒ…å«ä¼šè¯åˆå§‹åŒ–ä¿¡æ¯
  - å‡ºç°åœ¨ä¼šè¯å¼€å§‹æ—¶
  - å¸¸ç”¨äºè·å–åˆå§‹é…ç½®ä¿¡æ¯
  
- `"start"` - å¼€å§‹æ¶ˆæ¯
  - æ ‡è®°æŸä¸ªæµç¨‹æˆ–é˜¶æ®µçš„å¼€å§‹
  
- `"end"` - ç»“æŸæ¶ˆæ¯
  - æ ‡è®°æŸä¸ªæµç¨‹æˆ–é˜¶æ®µçš„ç»“æŸ
  
- å…¶ä»–ç³»ç»Ÿäº‹ä»¶é€šçŸ¥

**ä½¿ç”¨åœºæ™¯**:
- ä¼šè¯åˆå§‹åŒ–é€šçŸ¥
- æµç¨‹çŠ¶æ€å˜æ›´é€šçŸ¥
- ç³»ç»Ÿäº‹ä»¶å’ŒçŠ¶æ€åŒæ­¥
- å…ƒæ•°æ®ä¼ é€’

**ç¤ºä¾‹**:
```python
# åˆå§‹åŒ–æ¶ˆæ¯
{
    "type": "system",
    "subtype": "init",
    "data": {
        # åˆå§‹åŒ–ç›¸å…³çš„é…ç½®ä¿¡æ¯
    }
}

# æµç¨‹å¼€å§‹/ç»“æŸæ¶ˆæ¯
{
    "type": "system",
    "subtype": "start"  # æˆ– "end"
}
```

---

### 4. `type: "result"` - ç»“æœæ¶ˆæ¯

**å®šä¹‰ä½ç½®**: `src/claude_agent_sdk/types.py` (ç¬¬588-601è¡Œ)

**æ•°æ®ç»“æ„**:
```python
@dataclass
class ResultMessage:
    subtype: str
    duration_ms: int
    duration_api_ms: int
    is_error: bool
    num_turns: int
    session_id: str
    total_cost_usd: float | None = None
    usage: dict[str, Any] | None = None
    result: str | None = None
    structured_output: Any = None
```

**å­—æ®µè¯´æ˜**:
- `subtype`: ç»“æœçš„å­ç±»å‹
- `duration_ms`: æ€»æ‰§è¡Œæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
- `duration_api_ms`: API è°ƒç”¨æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
- `is_error`: æ˜¯å¦ä¸ºé”™è¯¯ç»“æœ
- `num_turns`: å¯¹è¯è½®æ¬¡æ•°
- `session_id`: ä¼šè¯ID
- `total_cost_usd`: æ€»æˆæœ¬ï¼ˆç¾å…ƒï¼‰
- `usage`: ä½¿ç”¨æƒ…å†µç»Ÿè®¡ï¼ˆtoken ä½¿ç”¨ç­‰ï¼‰
- `result`: ç»“æœæ–‡æœ¬
- `structured_output`: ç»“æ„åŒ–è¾“å‡ºï¼ˆå¦‚æœè¯·æ±‚äº†ç»“æ„åŒ–è¾“å‡ºï¼‰

**æ¶ˆæ¯å­ç±»å‹** (`subtype` å­—æ®µçš„å¯èƒ½å€¼):
- `"success"` - æˆåŠŸå®Œæˆ
  - æŸ¥è¯¢æˆ–ä»»åŠ¡æˆåŠŸæ‰§è¡Œ
  - `is_error` ä¸º `false`
  - åŒ…å«å®Œæ•´çš„æˆæœ¬å’Œä½¿ç”¨ç»Ÿè®¡
  
- `"error_max_budget_usd"` - é¢„ç®—è¶…é™é”™è¯¯
  - å½“æ‰§è¡Œæˆæœ¬è¶…è¿‡è®¾ç½®çš„æœ€å¤§é¢„ç®—æ—¶è¿”å›
  - `is_error` ä¸º `true`
  - åœ¨ `max_budget_usd` é€‰é¡¹è®¾ç½®æ—¶å¯èƒ½å‡ºç°

**ä½¿ç”¨åœºæ™¯**:
- æŸ¥è¯¢å®Œæˆåè¿”å›æœ€ç»ˆç»“æœ
- æä¾›æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯ï¼ˆæ—¶é•¿ã€æˆæœ¬ã€tokenä½¿ç”¨ç­‰ï¼‰
- æ ‡è®°ä¼šè¯ç»“æŸ
- è¿”å›ç»“æ„åŒ–è¾“å‡ºç»“æœ

**ç¤ºä¾‹**:
```python
# æˆåŠŸç»“æœ
{
    "type": "result",
    "subtype": "success",
    "duration_ms": 5000,
    "duration_api_ms": 3000,
    "is_error": false,
    "num_turns": 3,
    "session_id": "session_abc123",
    "total_cost_usd": 0.025,
    "usage": {
        "input_tokens": 1000,
        "output_tokens": 500
    }
}

# é¢„ç®—è¶…é™é”™è¯¯
{
    "type": "result",
    "subtype": "error_max_budget_usd",
    "is_error": true,
    "num_turns": 2,
    "session_id": "session_xyz789",
    # ... å…¶ä»–å­—æ®µ
}
```

---

### 5. `type: "stream_event"` - æµäº‹ä»¶æ¶ˆæ¯

**å®šä¹‰ä½ç½®**: `src/claude_agent_sdk/types.py` (ç¬¬604-611è¡Œ)

**æ•°æ®ç»“æ„**:
```python
@dataclass
class StreamEvent:
    uuid: str
    session_id: str
    event: dict[str, Any]  # åŸå§‹çš„ Anthropic API æµäº‹ä»¶
    parent_tool_use_id: str | None = None
```

**å­—æ®µè¯´æ˜**:
- `uuid`: æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦
- `session_id`: ä¼šè¯ID
- `event`: åŸå§‹çš„ Anthropic API æµå¼äº‹ä»¶æ•°æ®
- `parent_tool_use_id`: çˆ¶å·¥å…·ä½¿ç”¨IDï¼ˆå¯é€‰ï¼‰

**æ¶ˆæ¯å†…å®¹**:
`event` å­—æ®µåŒ…å«æ¥è‡ª Anthropic API çš„åŸå§‹æµå¼äº‹ä»¶ï¼Œå¯èƒ½çš„äº‹ä»¶ç±»å‹åŒ…æ‹¬ï¼š
- `"message_start"` - æ¶ˆæ¯å¼€å§‹
  - æ ‡è®°æ–°æ¶ˆæ¯çš„å¼€å§‹
  - åŒ…å«æ¶ˆæ¯çš„åˆå§‹å…ƒæ•°æ®
  
- `"content_block_start"` - å†…å®¹å—å¼€å§‹
  - æ ‡è®°æ–°å†…å®¹å—çš„å¼€å§‹
  - åŒ…å«å†…å®¹å—ç±»å‹ä¿¡æ¯
  
- `"content_block_delta"` - å†…å®¹å—å¢é‡
  - åŒ…å«å†…å®¹çš„å¢é‡æ›´æ–°
  - ç”¨äºå®æ—¶æ˜¾ç¤ºæ­£åœ¨ç”Ÿæˆçš„å†…å®¹
  
- `"content_block_stop"` - å†…å®¹å—ç»“æŸ
  - æ ‡è®°å†…å®¹å—ç”Ÿæˆå®Œæˆ
  
- `"message_delta"` - æ¶ˆæ¯å¢é‡
  - åŒ…å«æ¶ˆæ¯çº§åˆ«çš„å¢é‡æ›´æ–°
  
- `"message_stop"` - æ¶ˆæ¯ç»“æŸ
  - æ ‡è®°æ¶ˆæ¯ç”Ÿæˆå®Œæˆ

**ä½¿ç”¨åœºæ™¯**:
- å¯ç”¨éƒ¨åˆ†æ¶ˆæ¯æµå¼ä¼ è¾“æ—¶ä½¿ç”¨ï¼ˆ`include_partial_messages=True`ï¼‰
- å®æ—¶æ˜¾ç¤º Claude æ­£åœ¨ç”Ÿæˆçš„å“åº”
- æä¾›æ›´ç»†ç²’åº¦çš„è¿›åº¦åé¦ˆ
- å®ç°æ‰“å­—æœºæ•ˆæœçš„ UI

#### ç‰¹åˆ«è¯´æ˜ï¼š`stream_event` åŒ…å«çš„å†…å®¹ç±»å‹

**é‡è¦æ¦‚å¿µ**ï¼š`stream_event` **ä»…åŒ…å« assistant çš„æµå¼å†…å®¹ï¼Œä¸åŒ…å« user æ¶ˆæ¯**ã€‚

**åŒ…å«çš„ Delta ç±»å‹**ï¼š

1. **æ–‡æœ¬å†…å®¹** (`text_delta`)
   ```python
   # æœ€å¸¸è§ï¼šClaude ç”Ÿæˆçš„æ–‡æœ¬
   {"type": "content_block_delta", "delta": {"type": "text_delta", "text": "..."}}
   ```

2. **æ€è€ƒå†…å®¹** (`thinking_delta`)
   ```python
   # Claude çš„æ‰©å±•æ€è€ƒè¿‡ç¨‹
   {"type": "content_block_delta", "delta": {"type": "thinking_delta", "thinking": "..."}}
   ```

3. **å·¥å…·è°ƒç”¨å‚æ•°** (`input_json_delta`)
   ```python
   # Claude æ­£åœ¨æ„å»ºå·¥å…·è°ƒç”¨çš„è¾“å…¥å‚æ•°ï¼ˆæµå¼ï¼‰
   {"type": "content_block_delta", "delta": {"type": "input_json_delta", "partial_json": "..."}}
   ```

**å†…å®¹å—æµå¼æ”¯æŒ**ï¼š
- **TextBlock** - æ–‡æœ¬ âœ… å¯æµå¼ä¼ è¾“
- **ThinkingBlock** - æ€è€ƒ âœ… å¯æµå¼ä¼ è¾“
- **ToolUseBlock** - å·¥å…·è°ƒç”¨ âœ… å¯æµå¼ä¼ è¾“ï¼ˆå‚æ•°éƒ¨åˆ†ï¼‰
- **ToolResultBlock** - å·¥å…·ç»“æœ âŒ ä¸æµå¼ï¼ˆåœ¨ user æ¶ˆæ¯ä¸­å®Œæ•´å‘é€ï¼‰

**å­ä»£ç†æ”¯æŒ**ï¼š
`stream_event` æœ‰ `parent_tool_use_id` å­—æ®µï¼Œå¯ç”¨äºå­ä»£ç†ï¼ˆsubagentï¼‰çš„æµå¼è¾“å‡ºï¼š
```python
StreamEvent(
    uuid="...",
    session_id="...",
    event={...},
    parent_tool_use_id="toolu_abc123"  # å­ä»£ç†çš„çˆ¶å·¥å…·è°ƒç”¨ ID
)
```

**å…³é”®ç‰¹æ€§**ï¼š

1. **åŒé‡æ•°æ®æ¥æ”¶**ï¼šå¯ç”¨æµå¼æ¨¡å¼æ—¶ä¼šæ”¶åˆ°ä¸¤ä»½æ•°æ®
   - **å¢é‡å½¢å¼**ï¼šé€šè¿‡å¤šä¸ª `stream_event` é€å—æ¥æ”¶ï¼ˆç”¨äºå®æ—¶æ˜¾ç¤ºï¼‰
   - **å®Œæ•´å½¢å¼**ï¼šæœ€åä»ä¼šæ”¶åˆ°å®Œæ•´çš„ `assistant` æ¶ˆæ¯ï¼ˆç”¨äºå¤„ç†å’Œä¿å­˜ï¼‰
   
   ç¤ºä¾‹ï¼š
   ```python
   # æµå¼äº‹ä»¶ - å¢é‡
   StreamEvent: {"type": "content_block_delta", "delta": {"text": "ä½ å¥½"}}
   StreamEvent: {"type": "content_block_delta", "delta": {"text": "ï¼Œä¸–ç•Œ"}}
   StreamEvent: {"type": "content_block_delta", "delta": {"text": "ï¼"}}
   
   # æœ€ç»ˆå®Œæ•´æ¶ˆæ¯
   AssistantMessage: {"content": [{"type": "text", "text": "ä½ å¥½ï¼Œä¸–ç•Œï¼"}]}
   ```

2. **ä½¿ç”¨åœºæ™¯åŒºåˆ†**ï¼š
   - **`stream_event`**ï¼šç”¨äºå®æ—¶ UIï¼ˆæ‰“å­—æœºæ•ˆæœã€è¿›åº¦æ˜¾ç¤ºï¼‰
   - **`assistant` æ¶ˆæ¯**ï¼šç”¨äºå®Œæ•´å†…å®¹å¤„ç†ï¼ˆä¿å­˜ã€åˆ†æã€å¼•ç”¨ï¼‰

3. **é»˜è®¤è¡Œä¸º**ï¼š
   - å½“ `include_partial_messages=False`ï¼ˆé»˜è®¤ï¼‰æ—¶ï¼Œä¸ä¼šæ”¶åˆ°ä»»ä½• `stream_event`
   - åªæ”¶åˆ°å®Œæ•´çš„ `assistant` æ¶ˆæ¯
   - é€‚åˆä¸éœ€è¦å®æ—¶æ˜¾ç¤ºçš„åœºæ™¯

**ç¤ºä¾‹**:
```python
{
    "type": "stream_event",
    "uuid": "msg-abc123",
    "session_id": "session_xyz",
    "event": {
        "type": "content_block_delta",
        "index": 0,
        "delta": {
            "type": "text_delta",
            "text": "æ­£åœ¨ç”Ÿæˆçš„æ–‡æœ¬..."
        }
    }
}
```

**æ€»ç»“**ï¼š
- âœ… åŒ…å« assistant ç”Ÿæˆçš„æ‰€æœ‰ç±»å‹å†…å®¹ï¼ˆæ–‡æœ¬ã€æ€è€ƒã€å·¥å…·è°ƒç”¨å‚æ•°ï¼‰
- âœ… æ”¯æŒå­ä»£ç†åœºæ™¯
- âŒ ä¸åŒ…å« user æ¶ˆæ¯ï¼ˆç”¨æˆ·æ¶ˆæ¯æ€»æ˜¯å®Œæ•´å‘é€ï¼‰
- âŒ ä¸åŒ…å«å·¥å…·æ‰§è¡Œç»“æœï¼ˆåœ¨ user æ¶ˆæ¯ä¸­å®Œæ•´å‘é€ï¼‰
- âš ï¸ éœ€è¦æ˜¾å¼å¯ç”¨ `include_partial_messages=True`
- âš ï¸ æœ€åè¿˜ä¼šæ”¶åˆ°å®Œæ•´çš„ `assistant` æ¶ˆæ¯

---

### 6. `type: "error"` - é”™è¯¯æ¶ˆæ¯

**å®šä¹‰ä½ç½®**: `src/claude_agent_sdk/_internal/query.py` (ç¬¬597-598è¡Œ)

**æ•°æ®ç»“æ„**:
```python
{
    "type": "error",
    "error": str  # é”™è¯¯æè¿°ä¿¡æ¯
}
```

**å­—æ®µè¯´æ˜**:
- `error`: é”™è¯¯æè¿°å­—ç¬¦ä¸²

**ä½¿ç”¨åœºæ™¯**:
- å†…éƒ¨é”™è¯¯å¤„ç†
- SDK åˆ° CLI çš„é”™è¯¯ä¼ é€’
- ä¸­æ–­æ¶ˆæ¯æµå¹¶æŠ›å‡ºå¼‚å¸¸

**å¤„ç†æ–¹å¼**:
å½“æ”¶åˆ°æ­¤ç±»å‹æ¶ˆæ¯æ—¶ï¼ŒSDK ä¼šè‡ªåŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œä¸­æ–­æ¶ˆæ¯æ¥æ”¶æµç¨‹ã€‚

---

## äºŒã€æ§åˆ¶åè®®æ¶ˆæ¯ï¼ˆControl Protocolï¼‰

é™¤äº†ä¸Šè¿°å¸¸è§„æ¶ˆæ¯ç±»å‹å¤–ï¼ŒSDK è¿˜å®šä¹‰äº†ç”¨äºåŒå‘æ§åˆ¶åè®®çš„ç‰¹æ®Šæ¶ˆæ¯ç±»å‹ï¼š

### 1. `type: "control_request"` - æ§åˆ¶è¯·æ±‚

**å®šä¹‰ä½ç½®**: `src/claude_agent_sdk/types.py` (ç¬¬726-737è¡Œ)

è¿™æ˜¯ CLI å‘ SDK å‘é€çš„æ§åˆ¶è¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å­ç±»å‹ï¼ˆé€šè¿‡åµŒå¥—çš„ `request.subtype` å­—æ®µåŒºåˆ†ï¼‰ï¼š

#### å­ç±»å‹åˆ—è¡¨:
- `"interrupt"` - ä¸­æ–­è¯·æ±‚
  - è¯·æ±‚ä¸­æ–­å½“å‰æ‰§è¡Œ
  
- `"can_use_tool"` - å·¥å…·æƒé™è¯·æ±‚
  - CLI è¯·æ±‚ SDK ç¡®è®¤æ˜¯å¦å…è®¸ä½¿ç”¨æŸä¸ªå·¥å…·
  - åŒ…å« `tool_name`, `input`, `permission_suggestions`, `blocked_path` ç­‰å­—æ®µ
  
- `"initialize"` - åˆå§‹åŒ–è¯·æ±‚
  - ä¼šè¯åˆå§‹åŒ–æ¡æ‰‹
  - åŒ…å« hooks é…ç½®ä¿¡æ¯
  
- `"set_permission_mode"` - è®¾ç½®æƒé™æ¨¡å¼è¯·æ±‚
  - åŠ¨æ€ä¿®æ”¹æƒé™æ¨¡å¼
  - åŒ…å« `mode` å­—æ®µ
  
- `"hook_callback"` - Hook å›è°ƒè¯·æ±‚
  - CLI è°ƒç”¨ SDK æ³¨å†Œçš„ hook å‡½æ•°
  - åŒ…å« `callback_id`, `input`, `tool_use_id` ç­‰å­—æ®µ
  
- `"mcp_message"` - MCP æ¶ˆæ¯è¯·æ±‚
  - ä¸ MCP æœåŠ¡å™¨é€šä¿¡çš„æ¶ˆæ¯
  - åŒ…å« `server_name`, `message` å­—æ®µ
  
- `"rewind_files"` - æ–‡ä»¶å›é€€è¯·æ±‚
  - å°†æ–‡ä»¶å›é€€åˆ°æŒ‡å®šç”¨æˆ·æ¶ˆæ¯æ—¶çš„çŠ¶æ€
  - åŒ…å« `user_message_id` å­—æ®µ

---

### 2. `type: "control_response"` - æ§åˆ¶å“åº”

**å®šä¹‰ä½ç½®**: `src/claude_agent_sdk/types.py` (ç¬¬752-754è¡Œ)

è¿™æ˜¯ SDK å¯¹æ§åˆ¶è¯·æ±‚çš„å“åº”ï¼ŒåŒ…å«ä»¥ä¸‹å­ç±»å‹ï¼ˆé€šè¿‡åµŒå¥—çš„ `response.subtype` å­—æ®µåŒºåˆ†ï¼‰ï¼š

#### å­ç±»å‹åˆ—è¡¨:
- `"success"` - æˆåŠŸå“åº”
  - åŒ…å« `request_id` å’Œå¯é€‰çš„ `response` æ•°æ®
  
- `"error"` - é”™è¯¯å“åº”
  - åŒ…å« `request_id` å’Œ `error` æè¿°

---

## ä¸‰ã€æ¶ˆæ¯ç±»å‹æ€»ç»“è¡¨

| ç±»å‹ | ä¸»è¦ç”¨é€” | æ–¹å‘ | æ˜¯å¦æœ‰å­ç±»å‹ | å…³é”®å­—æ®µ |
|------|---------|------|-------------|---------|
| `user` | ç”¨æˆ·è¾“å…¥/æç¤º | SDK â†’ CLI | å¦ | `content`, `uuid` |
| `assistant` | Claude å›å¤ | CLI â†’ SDK | å¦ | `content`, `model`, `error` |
| `system` | ç³»ç»Ÿäº‹ä»¶é€šçŸ¥ | CLI â†’ SDK | æ˜¯ | `subtype`, `data` |
| `result` | æ‰§è¡Œç»“æœç»Ÿè®¡ | CLI â†’ SDK | æ˜¯ | `subtype`, `duration_ms`, `total_cost_usd` |
| `stream_event` | æµå¼äº‹ä»¶ | CLI â†’ SDK | å¦ | `event` (åŒ…å« Anthropic API äº‹ä»¶) |
| `error` | é”™è¯¯æ¶ˆæ¯ | åŒå‘ | å¦ | `error` |
| `control_request` | æ§åˆ¶è¯·æ±‚ | CLI â†’ SDK | æ˜¯ | `request_id`, `request` (åŒ…å« subtype) |
| `control_response` | æ§åˆ¶å“åº” | SDK â†’ CLI | æ˜¯ | `response` (åŒ…å« subtype) |

---

## å››ã€æ¶ˆæ¯æµè½¬æ¨¡å¼

### 4.1 å…¸å‹å¯¹è¯æµç¨‹ï¼ˆæ ‡å‡†å·¥å…·æ‰§è¡Œï¼‰

```
1. ç”¨æˆ·å‘é€ â†’ user æ¶ˆæ¯ï¼ˆè‡ªç„¶è¯­è¨€æç¤ºè¯ï¼‰
   ç¤ºä¾‹ï¼š"å¸®æˆ‘è¯»å– example.txt æ–‡ä»¶"
   
2. CLI å¯èƒ½å‘é€ â†’ system æ¶ˆæ¯ (init)

3. CLI å¯èƒ½å‘é€ â†’ control_request æ¶ˆæ¯ (initialize)

4. SDK å“åº” â†’ control_response æ¶ˆæ¯

5. CLI è¿”å› â†’ assistant æ¶ˆæ¯ (å¯èƒ½åŒ…å«å·¥å…·ä½¿ç”¨)
   ç¤ºä¾‹ï¼šåŒ…å« tool_use å—è¯·æ±‚ä½¿ç”¨ Read å·¥å…·
   
6. å¦‚æœéœ€è¦å·¥å…·æƒé™:
   - CLI å‘é€ â†’ control_request (can_use_tool)
   - SDK å“åº” â†’ control_response
   
7. CLI è‡ªåŠ¨æ‰§è¡Œå·¥å…·åè¿”å› â†’ user æ¶ˆæ¯ (åŒ…å« tool_result)
   æ³¨æ„ï¼šè™½ç„¶ç±»å‹æ˜¯ userï¼Œä½†è¿™æ˜¯ CLI ä»£è¡¨å·¥å…·æ‰§è¡Œç¯å¢ƒè¿”å›çš„ç»“æœ
   ä¸æ˜¯äººç±»ç”¨æˆ·å‘é€çš„
   
8. é‡å¤ 5-7 ç›´åˆ°ä»»åŠ¡å®Œæˆ

9. CLI è¿”å› â†’ result æ¶ˆæ¯

å…³é”®ç‚¹ï¼š
- äººç±»ç”¨æˆ·åªéœ€ç”¨è‡ªç„¶è¯­è¨€æè¿°éœ€æ±‚
- å·¥å…·è°ƒç”¨å’Œæ‰§è¡Œå®Œå…¨è‡ªåŠ¨åŒ–
- tool_use åœ¨ assistant æ¶ˆæ¯ä¸­ï¼Œtool_result åœ¨ user æ¶ˆæ¯ä¸­
- æ•´ä¸ªè¿‡ç¨‹å¯¹æœ€ç»ˆç”¨æˆ·é€æ˜
```

### 4.2 æµå¼æ¨¡å¼ï¼ˆå¯ç”¨ `include_partial_messages=True`ï¼‰

```
1. user æ¶ˆæ¯ï¼ˆå®Œæ•´ï¼‰
   - ç”¨æˆ·çš„æç¤ºè¯å®Œæ•´å‘é€
   - ä¸ä¼šè¢«æµå¼ä¼ è¾“
   
2. system æ¶ˆæ¯ (init)ï¼ˆå®Œæ•´ï¼‰

3. stream_event (message_start)           â† assistant å¼€å§‹ç”Ÿæˆ
   - æ ‡è®° Claude å¼€å§‹å›å¤
   
4. stream_event (content_block_start)     â† å†…å®¹å—å¼€å§‹
   - æŒ‡ç¤ºå†…å®¹å—ç±»å‹ï¼ˆtextã€thinkingã€tool_useï¼‰
   
5. å¤šä¸ª stream_event (content_block_delta) â† å¢é‡å†…å®¹
   - text_deltaï¼šæ–‡æœ¬å†…å®¹é€å­—/é€è¯ç”Ÿæˆ
   - thinking_deltaï¼šæ€è€ƒè¿‡ç¨‹é€æ­¥å±•ç¤º
   - input_json_deltaï¼šå·¥å…·è°ƒç”¨å‚æ•°é€æ­¥æ„å»º
   
6. stream_event (content_block_stop)      â† å†…å®¹å—ç»“æŸ

7. stream_event (message_stop)            â† assistant ç»“æŸ

8. assistant æ¶ˆæ¯ï¼ˆå®Œæ•´å†…å®¹ï¼‰              â† å®Œæ•´çš„ assistant æ¶ˆæ¯
   - åŒ…å«æ‰€æœ‰æµå¼ä¼ è¾“çš„å®Œæ•´å†…å®¹
   - ç”¨äºä¿å­˜å’Œåç»­å¤„ç†
   
9. result æ¶ˆæ¯ï¼ˆå®Œæ•´ï¼‰

é‡è¦è¯´æ˜ï¼š
- stream_event åªç”¨äº assistant å†…å®¹ï¼Œä¸ç”¨äº user
- ä¼šæ”¶åˆ°ä¸¤ä»½æ•°æ®ï¼šæµå¼å¢é‡ + æœ€ç»ˆå®Œæ•´æ¶ˆæ¯
- éœ€è¦æ˜¾å¼å¯ç”¨ include_partial_messages=True
- é€‚åˆéœ€è¦å®æ—¶æ˜¾ç¤ºçš„åœºæ™¯ï¼ˆæ‰“å­—æœºæ•ˆæœã€è¿›åº¦æ¡ç­‰ï¼‰
```

### 4.3 å­ä»£ç†åœºæ™¯

```
å½“ä½¿ç”¨å­ä»£ç†æ—¶ï¼Œæ¶ˆæ¯ä¼šåŒ…å« parent_tool_use_id å­—æ®µï¼š

1. ä¸» assistant æ¶ˆæ¯åŒ…å«å·¥å…·è°ƒç”¨
   - tool_use: è°ƒç”¨å­ä»£ç†å·¥å…·
   
2. å­ä»£ç†çš„ user/assistant/stream_event æ¶ˆæ¯
   - æ‰€æœ‰æ¶ˆæ¯éƒ½åŒ…å« parent_tool_use_id
   - ç”¨äºè¿½è¸ªæ¶ˆæ¯å±‚çº§å…³ç³»
   
3. å­ä»£ç†å®Œæˆåè¿”å› tool_result
   - åœ¨ user æ¶ˆæ¯ä¸­è¿”å›ç»™ä¸»ä»£ç†
```

---

## äº”ã€ä»£ç ä½ç½®ç´¢å¼•

### ä¸»è¦æ–‡ä»¶:
1. **ç±»å‹å®šä¹‰**: `src/claude_agent_sdk/types.py`
   - ç¬¬ 561-613 è¡Œ: åŸºç¡€æ¶ˆæ¯ç±»å‹å®šä¹‰
   - ç¬¬ 683-754 è¡Œ: æ§åˆ¶åè®®æ¶ˆæ¯å®šä¹‰

2. **æ¶ˆæ¯è§£æ**: `src/claude_agent_sdk/_internal/message_parser.py`
   - ç¬¬ 24-178 è¡Œ: `parse_message()` å‡½æ•°å®ç°
   - ä½¿ç”¨æ¨¡å¼åŒ¹é… (match-case) æ ¹æ® `type` å­—æ®µè§£æä¸åŒæ¶ˆæ¯

3. **æ¶ˆæ¯å¤„ç†**: `src/claude_agent_sdk/_internal/query.py`
   - ç¬¬ 164-210 è¡Œ: æ¶ˆæ¯æ¥æ”¶å’Œè·¯ç”±é€»è¾‘
   - ç¬¬ 230-330 è¡Œ: æ§åˆ¶è¯·æ±‚å¤„ç†é€»è¾‘

### æµ‹è¯•ç¤ºä¾‹:
- `tests/test_message_parser.py`: æ¶ˆæ¯è§£ææµ‹è¯•
- `e2e-tests/test_include_partial_messages.py`: æµå¼äº‹ä»¶æµ‹è¯•
- `examples/streaming_mode.py`: æµå¼æ¨¡å¼ä½¿ç”¨ç¤ºä¾‹

---

## å…­ã€å¸¸è§é—®é¢˜è§£ç­”ï¼ˆFAQï¼‰

### Q1: ä¸ºä»€ä¹ˆ `tool_result` ä¼šå‡ºç°åœ¨ `user` æ¶ˆæ¯ä¸­ï¼Ÿ

**A**: è¿™æ˜¯ Anthropic Messages API çš„æ ‡å‡†è®¾è®¡ã€‚è™½ç„¶æ¶ˆæ¯ç±»å‹æ˜¯ `user`ï¼Œä½†è¿™ä¸æ˜¯äººç±»ç”¨æˆ·å‘é€çš„ï¼Œè€Œæ˜¯ CLI ä»£è¡¨å·¥å…·æ‰§è¡Œç¯å¢ƒè¿”å›çš„ç»“æœã€‚

**æ ‡å‡†æµç¨‹**ï¼š
1. Claude åœ¨ `assistant` æ¶ˆæ¯ä¸­è¯·æ±‚ä½¿ç”¨å·¥å…·ï¼ˆåŒ…å« `tool_use` å—ï¼‰
2. CLI è‡ªåŠ¨æ‰§è¡Œå·¥å…·
3. å·¥å…·ç»“æœåœ¨ `user` æ¶ˆæ¯ä¸­è¿”å›ç»™ Claudeï¼ˆåŒ…å« `tool_result` å—ï¼‰

**å…³é”®ç‚¹**ï¼šäººç±»ç”¨æˆ·ä¸éœ€è¦ä»»ä½•æ“ä½œï¼Œæ•´ä¸ªè¿‡ç¨‹å®Œå…¨è‡ªåŠ¨åŒ–ã€‚

### Q2: äººç±»ç”¨æˆ·å¦‚ä½•ä¸»åŠ¨è°ƒç”¨å·¥å…·ï¼Ÿ

**A**: äººç±»ç”¨æˆ·**ä¸éœ€è¦ä¸»åŠ¨è°ƒç”¨å·¥å…·**ï¼Œåªéœ€ç”¨è‡ªç„¶è¯­è¨€æè¿°éœ€æ±‚ã€‚

**æ­£ç¡®æ–¹å¼**ï¼š
- âœ… è‡ªç„¶è¯­è¨€ï¼š"å¸®æˆ‘è¯»å– example.txt æ–‡ä»¶"
- âœ… è‡ªç„¶è¯­è¨€ï¼š"æ‰§è¡Œ ls -la å‘½ä»¤"

**é”™è¯¯ç†è§£**ï¼š
- âŒ ä¸éœ€è¦ç¼–å†™ä»£ç è°ƒç”¨å·¥å…·
- âŒ ä¸éœ€è¦æ„é€  `tool_use` æ¶ˆæ¯

å·¥å…·è°ƒç”¨ç”± Claude è‡ªåŠ¨å†³ç­–ï¼ŒCLI è‡ªåŠ¨æ‰§è¡Œï¼Œç»“æœè‡ªåŠ¨è¿”å›ã€‚

### Q3: ä»€ä¹ˆæ—¶å€™ä¼šåœ¨ `user` æ¶ˆæ¯ä¸­åŒ…å« `tool_use`ï¼Ÿ

**A**: è¿™æ˜¯ç‰¹æ®Šåœºæ™¯ï¼Œä¸»è¦æœ‰ä¸¤ç§æƒ…å†µï¼š

1. **å­ä»£ç†åœºæ™¯**ï¼šçˆ¶ä»£ç†è°ƒç”¨å­ä»£ç†æ—¶ï¼Œé€šè¿‡ `parent_tool_use_id` å…³è”
2. **ç¨‹åºåŒ–æ³¨å…¥**ï¼šé«˜çº§ç”¨æˆ·é€šè¿‡ä»£ç ç›´æ¥æ„é€ æ¶ˆæ¯ï¼ˆç”¨äºæµ‹è¯•æˆ–é¢„å¡«å……å†å²ï¼‰

**æ­£å¸¸ä½¿ç”¨ä¸ä¼šé‡åˆ°è¿™ç§æƒ…å†µ**ã€‚

### Q4: `stream_event` æ˜¯å¦åŒ…å«æ‰€æœ‰æ¶ˆæ¯çš„æµå¼ç‰ˆæœ¬ï¼Ÿ

**A**: ä¸æ˜¯ã€‚`stream_event` **åªåŒ…å« assistant æ¶ˆæ¯çš„æµå¼ç‰ˆæœ¬**ã€‚

**åŒ…å«**ï¼š
- âœ… Claude ç”Ÿæˆçš„æ–‡æœ¬ï¼ˆ`text_delta`ï¼‰
- âœ… Claude çš„æ€è€ƒè¿‡ç¨‹ï¼ˆ`thinking_delta`ï¼‰
- âœ… å·¥å…·è°ƒç”¨å‚æ•°ï¼ˆ`input_json_delta`ï¼‰

**ä¸åŒ…å«**ï¼š
- âŒ User æ¶ˆæ¯ï¼ˆæ€»æ˜¯å®Œæ•´å‘é€ï¼‰
- âŒ å·¥å…·æ‰§è¡Œç»“æœï¼ˆåœ¨ user æ¶ˆæ¯ä¸­å®Œæ•´å‘é€ï¼‰

### Q5: å¯ç”¨æµå¼æ¨¡å¼åï¼Œæ˜¯å¦åªæ”¶åˆ° `stream_event`ï¼Ÿ

**A**: ä¸æ˜¯ã€‚å¯ç”¨æµå¼æ¨¡å¼åä¼šæ”¶åˆ°**ä¸¤ä»½æ•°æ®**ï¼š

1. **å¢é‡æ•°æ®**ï¼šå¤šä¸ª `stream_event` æ¶ˆæ¯ï¼ˆç”¨äºå®æ—¶æ˜¾ç¤ºï¼‰
2. **å®Œæ•´æ•°æ®**ï¼šæœ€ç»ˆçš„ `assistant` æ¶ˆæ¯ï¼ˆç”¨äºä¿å­˜å’Œå¤„ç†ï¼‰

**ç¤ºä¾‹**ï¼š
```python
# å…ˆæ”¶åˆ°æµå¼å¢é‡
StreamEvent: {"delta": {"text": "ä½ å¥½"}}
StreamEvent: {"delta": {"text": "ï¼Œä¸–ç•Œ"}}

# ç„¶åæ”¶åˆ°å®Œæ•´æ¶ˆæ¯
AssistantMessage: {"content": [{"text": "ä½ å¥½ï¼Œä¸–ç•Œ"}]}
```

### Q6: å¦‚ä½•é€‰æ‹©æ˜¯å¦å¯ç”¨æµå¼æ¨¡å¼ï¼Ÿ

**A**: æ ¹æ®åº”ç”¨åœºæ™¯é€‰æ‹©ï¼š

**å¯ç”¨æµå¼** (`include_partial_messages=True`)ï¼š
- âœ… éœ€è¦å®æ—¶ UIï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
- âœ… éœ€è¦æ˜¾ç¤ºç”Ÿæˆè¿›åº¦
- âœ… äº¤äº’å¼åº”ç”¨ï¼Œç”¨æˆ·å¸Œæœ›çœ‹åˆ°å³æ—¶åé¦ˆ

**ä¸å¯ç”¨æµå¼**ï¼ˆé»˜è®¤ï¼‰ï¼š
- âœ… åªå…³å¿ƒæœ€ç»ˆç»“æœ
- âœ… æ‰¹å¤„ç†ä»»åŠ¡
- âœ… ä¸éœ€è¦å®æ—¶æ˜¾ç¤ºçš„åœºæ™¯

### Q7: å­ä»£ç†æ¶ˆæ¯å¦‚ä½•è¯†åˆ«ï¼Ÿ

**A**: é€šè¿‡ `parent_tool_use_id` å­—æ®µè¯†åˆ«ã€‚

æ‰€æœ‰æ¶ˆæ¯ç±»å‹ï¼ˆ`user`ã€`assistant`ã€`stream_event`ï¼‰éƒ½æœ‰æ­¤å­—æ®µï¼š
```python
# ä¸»ä»£ç†çš„æ¶ˆæ¯
message.parent_tool_use_id == None

# å­ä»£ç†çš„æ¶ˆæ¯
message.parent_tool_use_id == "toolu_abc123"
```

---

## ä¸ƒã€å¼€å‘å»ºè®®

### 7.1 æ¶ˆæ¯å¤„ç†æœ€ä½³å®è·µ

1. **ç±»å‹æ£€æŸ¥**: ä½¿ç”¨ `isinstance()` æ£€æŸ¥æ¶ˆæ¯ç±»å‹
   ```python
   if isinstance(message, AssistantMessage):
       # å¤„ç†åŠ©æ‰‹æ¶ˆæ¯
   elif isinstance(message, ResultMessage):
       # å¤„ç†ç»“æœæ¶ˆæ¯
   ```

2. **å†…å®¹å—éå†**: éå†å†…å®¹å—æ—¶æ£€æŸ¥å…·ä½“ç±»å‹
   ```python
   for block in message.content:
       if isinstance(block, TextBlock):
           print(block.text)
       elif isinstance(block, ToolUseBlock):
           # å¤„ç†å·¥å…·ä½¿ç”¨
   ```

3. **ç³»ç»Ÿæ¶ˆæ¯è¿‡æ»¤**: æ ¹æ® `subtype` å¤„ç†ä¸åŒç³»ç»Ÿäº‹ä»¶
   ```python
   if isinstance(msg, SystemMessage) and msg.subtype == "init":
       # å¤„ç†åˆå§‹åŒ–
   ```

4. **ç»“æœæ£€æŸ¥**: æ£€æŸ¥ç»“æœæ¶ˆæ¯çš„å­ç±»å‹å’Œé”™è¯¯æ ‡å¿—
   ```python
   if isinstance(msg, ResultMessage):
       if msg.subtype == "success":
           print(f"Cost: ${msg.total_cost_usd}")
       elif msg.subtype == "error_max_budget_usd":
           print("Budget exceeded!")
   ```

### 7.2 æµå¼æ¶ˆæ¯å¤„ç†

å¯ç”¨æµå¼æ¨¡å¼éœ€è¦:
```python
options = ClaudeAgentOptions(include_partial_messages=True)
```

å¤„ç†æµå¼äº‹ä»¶:
```python
if isinstance(message, StreamEvent):
    event_type = message.event.get("type")
    if event_type == "content_block_delta":
        delta = message.event.get("delta", {})
        if delta.get("type") == "text_delta":
            print(delta.get("text"), end="", flush=True)
```

---

## å…«ã€æ‰©å±•ä¿¡æ¯

### 8.1 ContentBlock ç±»å‹è¯¦è§£

æ‰€æœ‰æ¶ˆæ¯å†…å®¹éƒ½é€šè¿‡ ContentBlock ç±»å‹æ‰¿è½½ï¼š

```python
ContentBlock = TextBlock | ThinkingBlock | ToolUseBlock | ToolResultBlock
```

- **TextBlock**: æœ€å¸¸è§ï¼ŒåŒ…å«æ–‡æœ¬å†…å®¹
- **ThinkingBlock**: Claude çš„æ‰©å±•æ€è€ƒï¼ˆéœ€è¦ç‰¹å®šæ¨¡å‹æ”¯æŒï¼‰
- **ToolUseBlock**: å·¥å…·è°ƒç”¨è¯·æ±‚æˆ–è®°å½•
- **ToolResultBlock**: å·¥å…·æ‰§è¡Œç»“æœ

### 8.2 å·¥å…·æƒé™æµç¨‹

å·¥å…·æƒé™é€šè¿‡æ§åˆ¶åè®®å®ç°ï¼š
1. Claude è¯·æ±‚ä½¿ç”¨å·¥å…· â†’ `assistant` æ¶ˆæ¯åŒ…å« `ToolUseBlock`
2. CLI è¯¢é—® SDK â†’ `control_request` (can_use_tool)
3. SDK å›è°ƒç”¨æˆ·å‡½æ•° â†’ `can_use_tool` callback
4. SDK è¿”å›å†³ç­– â†’ `control_response` (allow/deny)
5. å¦‚æœå…è®¸ï¼Œæ‰§è¡Œå·¥å…·å¹¶è¿”å›ç»“æœ

### 8.3 Hook æœºåˆ¶

Hooks å…è®¸åœ¨ç‰¹å®šäº‹ä»¶æ—¶æ‰§è¡Œè‡ªå®šä¹‰ä»£ç ï¼š
- é€šè¿‡ `control_request` (hook_callback) è°ƒç”¨
- æ”¯æŒçš„äº‹ä»¶: PreToolUse, PostToolUse, UserPromptSubmit, Stop, SubagentStop, PreCompact
- Hook å¯ä»¥ä¿®æ”¹è¡Œä¸ºã€æ·»åŠ ä¸Šä¸‹æ–‡æˆ–é˜»æ­¢æ“ä½œ

---

## ä¹ã€æ€»ç»“

Claude Agent SDK Python çš„æ¶ˆæ¯ç³»ç»Ÿè®¾è®¡æ¸…æ™°ï¼Œå±‚æ¬¡åˆ†æ˜ï¼š

1. **ç”¨æˆ·äº¤äº’å±‚**: `user` å’Œ `assistant` æ¶ˆæ¯å¤„ç†ä¸»è¦å¯¹è¯å†…å®¹
   - äººç±»ç”¨æˆ·é€šè¿‡è‡ªç„¶è¯­è¨€äº¤äº’ï¼Œæ— éœ€ç¼–å†™å·¥å…·è°ƒç”¨ä»£ç 
   - Claude è‡ªåŠ¨å†³ç­–å·¥å…·ä½¿ç”¨ï¼ŒCLI è‡ªåŠ¨æ‰§è¡Œ
   
2. **ç³»ç»Ÿæ§åˆ¶å±‚**: `system` å’Œ `result` æ¶ˆæ¯æä¾›å…ƒä¿¡æ¯å’Œç»Ÿè®¡
   - ç³»ç»Ÿæ¶ˆæ¯ä¼ é€’çŠ¶æ€å’Œé…ç½®
   - ç»“æœæ¶ˆæ¯æä¾›æˆæœ¬ã€æ—¶é•¿ã€ä½¿ç”¨é‡ç­‰ç»Ÿè®¡
   
3. **æµå¼ä¼ è¾“å±‚**: `stream_event` æ¶ˆæ¯æ”¯æŒå®æ—¶å†…å®¹æ›´æ–°
   - åªç”¨äº assistant å†…å®¹çš„æµå¼ä¼ è¾“
   - æ”¯æŒæ–‡æœ¬ã€æ€è€ƒã€å·¥å…·è°ƒç”¨å‚æ•°çš„å¢é‡æ›´æ–°
   - æœ€ç»ˆä»ä¼šæ”¶åˆ°å®Œæ•´çš„ assistant æ¶ˆæ¯
   
4. **æ§åˆ¶åè®®å±‚**: `control_request` å’Œ `control_response` å®ç° SDK-CLI åŒå‘é€šä¿¡
   - å·¥å…·æƒé™ç®¡ç†
   - Hook å›è°ƒæœºåˆ¶
   - MCP æœåŠ¡å™¨é€šä¿¡
   
5. **é”™è¯¯å¤„ç†å±‚**: `error` æ¶ˆæ¯å’Œå„ç§é”™è¯¯å­ç±»å‹å¤„ç†å¼‚å¸¸æƒ…å†µ

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… å·¥å…·è°ƒç”¨å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œå¯¹ç”¨æˆ·é€æ˜
- âœ… æµå¼æ¨¡å¼å¯é€‰ï¼Œé€‚åº”ä¸åŒåº”ç”¨åœºæ™¯
- âœ… æ”¯æŒå­ä»£ç†å’Œå¤æ‚å·¥ä½œæµ
- âœ… æä¾›å®Œæ•´çš„åŒå‘æ§åˆ¶åè®®
- âœ… æ¸…æ™°çš„æ¶ˆæ¯ç±»å‹å’Œå†…å®¹å—è®¾è®¡

è¿™ç§è®¾è®¡ä½¿å¾— SDK æ—¢èƒ½æ”¯æŒç®€å•çš„å•æ¬¡æŸ¥è¯¢ï¼Œä¹Ÿèƒ½æ”¯æŒå¤æ‚çš„äº¤äº’å¼ä¼šè¯ï¼ŒåŒæ—¶æä¾›äº†å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›ï¼ˆå·¥å…·æƒé™ã€Hooksã€MCP æœåŠ¡å™¨ç­‰ï¼‰ã€‚
