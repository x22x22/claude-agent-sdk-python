# Claude Agent SDK Python 消息类型分析报告

## 概述

本报告分析了 Claude Agent SDK Python 项目中报文（消息）的第一层 `type` 字段的定义及其包含的具体消息内容。该SDK使用基于 JSON 的消息协议与 Claude Code CLI 进行通信。

## 一、消息类型架构

消息的第一层包含一个 `type` 字段，用于区分不同类型的消息。主要有以下几种类型：

### 1. `type: "user"` - 用户消息

**定义位置**: `src/claude_agent_sdk/types.py` (第561-567行)

**数据结构**:
```python
@dataclass
class UserMessage:
    content: str | list[ContentBlock]
    uuid: str | None = None
    parent_tool_use_id: str | None = None
```

**字段说明**:
- `content`: 用户消息的内容，可以是简单字符串或内容块列表
- `uuid`: 消息的唯一标识符（可选），用于文件检查点功能
- `parent_tool_use_id`: 父工具使用ID（可选），用于子代理场景

**消息内容**:
用户消息可以包含以下类型的内容块（ContentBlock）：
- **TextBlock**: 纯文本内容
  ```python
  {"type": "text", "text": "具体的文本内容"}
  ```
- **ToolUseBlock**: 工具使用请求
  ```python
  {
      "type": "tool_use",
      "id": "tool_123",
      "name": "Read",
      "input": {"file_path": "/example.txt"}
  }
  ```
- **ToolResultBlock**: 工具执行结果
  ```python
  {
      "type": "tool_result",
      "tool_use_id": "tool_456",
      "content": "工具返回的内容",
      "is_error": false
  }
  ```

**使用场景**:
- 用户向 Claude 发送的提示词或问题
- 在多轮对话中用户的后续输入
- 包含工具调用请求的消息
- 返回工具执行结果给 Claude

---

### 2. `type: "assistant"` - 助手消息

**定义位置**: `src/claude_agent_sdk/types.py` (第570-577行)

**数据结构**:
```python
@dataclass
class AssistantMessage:
    content: list[ContentBlock]
    model: str
    parent_tool_use_id: str | None = None
    error: AssistantMessageError | None = None
```

**字段说明**:
- `content`: 助手回复的内容块列表
- `model`: 使用的模型名称（如 "claude-opus-4-1-20250805"）
- `parent_tool_use_id`: 父工具使用ID（可选），用于子代理场景
- `error`: 错误类型（可选），可能的值包括：
  - `"authentication_failed"` - 认证失败
  - `"billing_error"` - 计费错误
  - `"rate_limit"` - 速率限制
  - `"invalid_request"` - 无效请求
  - `"server_error"` - 服务器错误
  - `"unknown"` - 未知错误

**消息内容**:
助手消息可以包含以下类型的内容块：
- **TextBlock**: Claude 的文本回复
  ```python
  {"type": "text", "text": "Claude 的回答"}
  ```
- **ThinkingBlock**: Claude 的思考过程（扩展思考功能）
  ```python
  {
      "type": "thinking",
      "thinking": "我正在思考这个问题...",
      "signature": "sig-123"
  }
  ```
- **ToolUseBlock**: Claude 请求使用工具
  ```python
  {
      "type": "tool_use",
      "id": "tool_789",
      "name": "Bash",
      "input": {"command": "ls -la"}
  }
  ```
- **ToolResultBlock**: 工具执行结果（在某些情况下）
  ```python
  {
      "type": "tool_result",
      "tool_use_id": "tool_789",
      "content": "文件列表...",
      "is_error": false
  }
  ```

**使用场景**:
- Claude 对用户问题的文本回复
- Claude 请求使用工具（如读取文件、执行命令等）
- Claude 的扩展思考内容
- API 错误响应

---

### 3. `type: "system"` - 系统消息

**定义位置**: `src/claude_agent_sdk/types.py` (第580-584行)

**数据结构**:
```python
@dataclass
class SystemMessage:
    subtype: str
    data: dict[str, Any]
```

**字段说明**:
- `subtype`: 系统消息的子类型，标识具体的系统事件
- `data`: 包含完整消息数据的字典

**消息子类型** (`subtype` 字段的可能值):
- `"init"` - 初始化消息
  - 包含会话初始化信息
  - 出现在会话开始时
  - 常用于获取初始配置信息
  
- `"start"` - 开始消息
  - 标记某个流程或阶段的开始
  
- `"end"` - 结束消息
  - 标记某个流程或阶段的结束
  
- 其他系统事件通知

**使用场景**:
- 会话初始化通知
- 流程状态变更通知
- 系统事件和状态同步
- 元数据传递

**示例**:
```python
# 初始化消息
{
    "type": "system",
    "subtype": "init",
    "data": {
        # 初始化相关的配置信息
    }
}

# 流程开始/结束消息
{
    "type": "system",
    "subtype": "start"  # 或 "end"
}
```

---

### 4. `type: "result"` - 结果消息

**定义位置**: `src/claude_agent_sdk/types.py` (第588-601行)

**数据结构**:
```python
@dataclass
class ResultMessage:
    subtype: str
    duration_ms: int
    duration_api_ms: int
    is_error: bool
    num_turns: int
    session_id: str
    total_cost_usd: float | None = None
    usage: dict[str, Any] | None = None
    result: str | None = None
    structured_output: Any = None
```

**字段说明**:
- `subtype`: 结果的子类型
- `duration_ms`: 总执行时长（毫秒）
- `duration_api_ms`: API 调用时长（毫秒）
- `is_error`: 是否为错误结果
- `num_turns`: 对话轮次数
- `session_id`: 会话ID
- `total_cost_usd`: 总成本（美元）
- `usage`: 使用情况统计（token 使用等）
- `result`: 结果文本
- `structured_output`: 结构化输出（如果请求了结构化输出）

**消息子类型** (`subtype` 字段的可能值):
- `"success"` - 成功完成
  - 查询或任务成功执行
  - `is_error` 为 `false`
  - 包含完整的成本和使用统计
  
- `"error_max_budget_usd"` - 预算超限错误
  - 当执行成本超过设置的最大预算时返回
  - `is_error` 为 `true`
  - 在 `max_budget_usd` 选项设置时可能出现

**使用场景**:
- 查询完成后返回最终结果
- 提供执行统计信息（时长、成本、token使用等）
- 标记会话结束
- 返回结构化输出结果

**示例**:
```python
# 成功结果
{
    "type": "result",
    "subtype": "success",
    "duration_ms": 5000,
    "duration_api_ms": 3000,
    "is_error": false,
    "num_turns": 3,
    "session_id": "session_abc123",
    "total_cost_usd": 0.025,
    "usage": {
        "input_tokens": 1000,
        "output_tokens": 500
    }
}

# 预算超限错误
{
    "type": "result",
    "subtype": "error_max_budget_usd",
    "is_error": true,
    "num_turns": 2,
    "session_id": "session_xyz789",
    # ... 其他字段
}
```

---

### 5. `type: "stream_event"` - 流事件消息

**定义位置**: `src/claude_agent_sdk/types.py` (第604-611行)

**数据结构**:
```python
@dataclass
class StreamEvent:
    uuid: str
    session_id: str
    event: dict[str, Any]  # 原始的 Anthropic API 流事件
    parent_tool_use_id: str | None = None
```

**字段说明**:
- `uuid`: 消息的唯一标识符
- `session_id`: 会话ID
- `event`: 原始的 Anthropic API 流式事件数据
- `parent_tool_use_id`: 父工具使用ID（可选）

**消息内容**:
`event` 字段包含来自 Anthropic API 的原始流式事件，可能的事件类型包括：
- `"message_start"` - 消息开始
  - 标记新消息的开始
  - 包含消息的初始元数据
  
- `"content_block_start"` - 内容块开始
  - 标记新内容块的开始
  - 包含内容块类型信息
  
- `"content_block_delta"` - 内容块增量
  - 包含内容的增量更新
  - 用于实时显示正在生成的内容
  
- `"content_block_stop"` - 内容块结束
  - 标记内容块生成完成
  
- `"message_delta"` - 消息增量
  - 包含消息级别的增量更新
  
- `"message_stop"` - 消息结束
  - 标记消息生成完成

**使用场景**:
- 启用部分消息流式传输时使用（`include_partial_messages=True`）
- 实时显示 Claude 正在生成的响应
- 提供更细粒度的进度反馈
- 实现打字机效果的 UI

**示例**:
```python
{
    "type": "stream_event",
    "uuid": "msg-abc123",
    "session_id": "session_xyz",
    "event": {
        "type": "content_block_delta",
        "index": 0,
        "delta": {
            "type": "text_delta",
            "text": "正在生成的文本..."
        }
    }
}
```

---

### 6. `type: "error"` - 错误消息

**定义位置**: `src/claude_agent_sdk/_internal/query.py` (第597-598行)

**数据结构**:
```python
{
    "type": "error",
    "error": str  # 错误描述信息
}
```

**字段说明**:
- `error`: 错误描述字符串

**使用场景**:
- 内部错误处理
- SDK 到 CLI 的错误传递
- 中断消息流并抛出异常

**处理方式**:
当收到此类型消息时，SDK 会自动抛出异常，中断消息接收流程。

---

## 二、控制协议消息（Control Protocol）

除了上述常规消息类型外，SDK 还定义了用于双向控制协议的特殊消息类型：

### 1. `type: "control_request"` - 控制请求

**定义位置**: `src/claude_agent_sdk/types.py` (第726-737行)

这是 CLI 向 SDK 发送的控制请求，包含以下子类型（通过嵌套的 `request.subtype` 字段区分）：

#### 子类型列表:
- `"interrupt"` - 中断请求
  - 请求中断当前执行
  
- `"can_use_tool"` - 工具权限请求
  - CLI 请求 SDK 确认是否允许使用某个工具
  - 包含 `tool_name`, `input`, `permission_suggestions`, `blocked_path` 等字段
  
- `"initialize"` - 初始化请求
  - 会话初始化握手
  - 包含 hooks 配置信息
  
- `"set_permission_mode"` - 设置权限模式请求
  - 动态修改权限模式
  - 包含 `mode` 字段
  
- `"hook_callback"` - Hook 回调请求
  - CLI 调用 SDK 注册的 hook 函数
  - 包含 `callback_id`, `input`, `tool_use_id` 等字段
  
- `"mcp_message"` - MCP 消息请求
  - 与 MCP 服务器通信的消息
  - 包含 `server_name`, `message` 字段
  
- `"rewind_files"` - 文件回退请求
  - 将文件回退到指定用户消息时的状态
  - 包含 `user_message_id` 字段

---

### 2. `type: "control_response"` - 控制响应

**定义位置**: `src/claude_agent_sdk/types.py` (第752-754行)

这是 SDK 对控制请求的响应，包含以下子类型（通过嵌套的 `response.subtype` 字段区分）：

#### 子类型列表:
- `"success"` - 成功响应
  - 包含 `request_id` 和可选的 `response` 数据
  
- `"error"` - 错误响应
  - 包含 `request_id` 和 `error` 描述

---

## 三、消息类型总结表

| 类型 | 主要用途 | 方向 | 是否有子类型 | 关键字段 |
|------|---------|------|-------------|---------|
| `user` | 用户输入/提示 | SDK → CLI | 否 | `content`, `uuid` |
| `assistant` | Claude 回复 | CLI → SDK | 否 | `content`, `model`, `error` |
| `system` | 系统事件通知 | CLI → SDK | 是 | `subtype`, `data` |
| `result` | 执行结果统计 | CLI → SDK | 是 | `subtype`, `duration_ms`, `total_cost_usd` |
| `stream_event` | 流式事件 | CLI → SDK | 否 | `event` (包含 Anthropic API 事件) |
| `error` | 错误消息 | 双向 | 否 | `error` |
| `control_request` | 控制请求 | CLI → SDK | 是 | `request_id`, `request` (包含 subtype) |
| `control_response` | 控制响应 | SDK → CLI | 是 | `response` (包含 subtype) |

---

## 四、消息流转模式

### 4.1 典型对话流程

```
1. 用户发送 → user 消息
2. CLI 可能发送 → system 消息 (init)
3. CLI 可能发送 → control_request 消息 (initialize)
4. SDK 响应 → control_response 消息
5. CLI 返回 → assistant 消息 (可能包含工具使用)
6. 如果需要工具权限:
   - CLI 发送 → control_request (can_use_tool)
   - SDK 响应 → control_response
7. 执行工具后返回 → user 消息 (包含 tool_result)
8. 重复 5-7 直到任务完成
9. CLI 返回 → result 消息
```

### 4.2 流式模式

当启用 `include_partial_messages=True` 时：

```
1. user 消息
2. system 消息 (init)
3. stream_event (message_start)
4. stream_event (content_block_start)
5. 多个 stream_event (content_block_delta) - 逐步生成内容
6. stream_event (content_block_stop)
7. stream_event (message_stop)
8. assistant 消息 (完整内容)
9. result 消息
```

---

## 五、代码位置索引

### 主要文件:
1. **类型定义**: `src/claude_agent_sdk/types.py`
   - 第 561-613 行: 基础消息类型定义
   - 第 683-754 行: 控制协议消息定义

2. **消息解析**: `src/claude_agent_sdk/_internal/message_parser.py`
   - 第 24-178 行: `parse_message()` 函数实现
   - 使用模式匹配 (match-case) 根据 `type` 字段解析不同消息

3. **消息处理**: `src/claude_agent_sdk/_internal/query.py`
   - 第 164-210 行: 消息接收和路由逻辑
   - 第 230-330 行: 控制请求处理逻辑

### 测试示例:
- `tests/test_message_parser.py`: 消息解析测试
- `e2e-tests/test_include_partial_messages.py`: 流式事件测试
- `examples/streaming_mode.py`: 流式模式使用示例

---

## 六、开发建议

### 6.1 消息处理最佳实践

1. **类型检查**: 使用 `isinstance()` 检查消息类型
   ```python
   if isinstance(message, AssistantMessage):
       # 处理助手消息
   elif isinstance(message, ResultMessage):
       # 处理结果消息
   ```

2. **内容块遍历**: 遍历内容块时检查具体类型
   ```python
   for block in message.content:
       if isinstance(block, TextBlock):
           print(block.text)
       elif isinstance(block, ToolUseBlock):
           # 处理工具使用
   ```

3. **系统消息过滤**: 根据 `subtype` 处理不同系统事件
   ```python
   if isinstance(msg, SystemMessage) and msg.subtype == "init":
       # 处理初始化
   ```

4. **结果检查**: 检查结果消息的子类型和错误标志
   ```python
   if isinstance(msg, ResultMessage):
       if msg.subtype == "success":
           print(f"Cost: ${msg.total_cost_usd}")
       elif msg.subtype == "error_max_budget_usd":
           print("Budget exceeded!")
   ```

### 6.2 流式消息处理

启用流式模式需要:
```python
options = ClaudeAgentOptions(include_partial_messages=True)
```

处理流式事件:
```python
if isinstance(message, StreamEvent):
    event_type = message.event.get("type")
    if event_type == "content_block_delta":
        delta = message.event.get("delta", {})
        if delta.get("type") == "text_delta":
            print(delta.get("text"), end="", flush=True)
```

---

## 七、扩展信息

### 7.1 ContentBlock 类型详解

所有消息内容都通过 ContentBlock 类型承载：

```python
ContentBlock = TextBlock | ThinkingBlock | ToolUseBlock | ToolResultBlock
```

- **TextBlock**: 最常见，包含文本内容
- **ThinkingBlock**: Claude 的扩展思考（需要特定模型支持）
- **ToolUseBlock**: 工具调用请求或记录
- **ToolResultBlock**: 工具执行结果

### 7.2 工具权限流程

工具权限通过控制协议实现：
1. Claude 请求使用工具 → `assistant` 消息包含 `ToolUseBlock`
2. CLI 询问 SDK → `control_request` (can_use_tool)
3. SDK 回调用户函数 → `can_use_tool` callback
4. SDK 返回决策 → `control_response` (allow/deny)
5. 如果允许，执行工具并返回结果

### 7.3 Hook 机制

Hooks 允许在特定事件时执行自定义代码：
- 通过 `control_request` (hook_callback) 调用
- 支持的事件: PreToolUse, PostToolUse, UserPromptSubmit, Stop, SubagentStop, PreCompact
- Hook 可以修改行为、添加上下文或阻止操作

---

## 八、总结

Claude Agent SDK Python 的消息系统设计清晰，层次分明：

1. **用户交互层**: `user` 和 `assistant` 消息处理主要对话内容
2. **系统控制层**: `system` 和 `result` 消息提供元信息和统计
3. **流式传输层**: `stream_event` 消息支持实时内容更新
4. **控制协议层**: `control_request` 和 `control_response` 实现 SDK-CLI 双向通信
5. **错误处理层**: `error` 消息和各种错误子类型处理异常情况

这种设计使得 SDK 既能支持简单的单次查询，也能支持复杂的交互式会话，同时提供了强大的扩展能力（工具权限、Hooks、MCP 服务器等）。
